{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment - Devki Mart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background: #fffaf0; }
    .payment-card { border: 2px solid #ddd; padding: 20px; border-radius: 14px; cursor: pointer; }
    .payment-card.selected { border-color:#eea13d; background:#fff1dc; }
    .submit-btn { background:#eea13d; }
    .submit-btn:hover { background:#cc7a0a; }
  </style>
</head>

<body class="min-h-screen py-10">

<div class="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl p-10">

  <h2 class="text-center text-3xl font-bold mb-10 text-gray-900">Secure Payment</h2>

  <form id="paymentForm" method="POST">
    {% csrf_token %}

    <!-- STEP 1 -->
    <h3 class="text-xl font-semibold text-gray-800 mb-3">Choose Payment Method</h3>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
      <label class="payment-card">
        <input type="radio" name="payment_method" value="card" class="hidden" onchange="selectMethod(this)">
        Credit / Debit Card
      </label>

      <label class="payment-card">
        <input type="radio" name="payment_method" value="upi" class="hidden" onchange="selectMethod(this)">
        UPI (GPay / PhonePe)
      </label>

      <label class="payment-card">
        <input type="radio" name="payment_method" value="cod" class="hidden" onchange="selectMethod(this)">
        Cash On Delivery
      </label>
    </div>

    <!-- STEP 2 -->
    <h3 class="text-xl font-semibold text-gray-800 mb-3">Order Summary</h3>

    <div class="bg-amber-50 p-6 rounded-xl mb-10">
      <div class="flex justify-between text-lg font-medium">
        <span>Total Amount:</span>
        <span class="text-2xl font-bold text-amber-600">â‚¹{{ total }}</span>
      </div>
    </div>

    <!-- MAIN BUTTON -->
    <button id="payBtn" type="button" onclick="startPayment()" 
  class="submit-btn w-full py-4 text-xl text-white rounded-xl">
  Proceed to Payment
</button>

  </form>

</div>

<script>

  function startLoader() {
    const btn = document.getElementById("payBtn");
    btn.disabled = true;
    btn.innerHTML = `<span class="animate-pulse">Processing Payment...</span>`;
}

function stopLoader() {
    const btn = document.getElementById("payBtn");
    btn.disabled = false;
    btn.innerHTML = "Proceed to Payment";
}

let selected = null;

function selectMethod(input) {
  selected = input.value;
  document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('selected'));
  input.closest('.payment-card').classList.add('selected');
}

async function startPayment() {
  startLoader();

  if (!selected) {
      Swal.fire("Select a payment method!", "", "warning");
      return;
  }

  // CASH ON DELIVERY FLOW
  if (selected === "cod") {
    console.log("COD selected â€” placing order...");
    stopLoader(); // Stop loader
    window.location.href = "{% url 'cod_order' %}";
    return;
}


  // UPI / CARD RAZORPAY FLOW
  let response = await fetch("{% url 'razorpay_create_order' %}", {
      method: "POST",
      headers: {"X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value}
  });
  let data = await response.json();

  if (!data || !data.order_id) {
    stopLoader();
    Swal.fire("Error", "Unable to create payment order!", "error");
    return;
  }


  let options = {
    key: data.razorpay_key,  // <----- FIXED
    amount: data.amount,
    currency: "INR",
    name: "Devki Mart",
    description: "Order Payment",
    order_id: data.order_id,
    customer: {
    name: "{{ request.user.username }}",
    email: "{{ request.user.email }}",
    contact: "{{ checkout_info.phone_number }}"
    },
    notes: {
        product_name: "NewWayOnline Order"
    },

    redirect: false, // <----- ensures SPA popup close event triggers handler
    theme: { color: "#eea13d" },

    handler: function (payment) {
        console.log("ðŸ”¥ Handler Triggered:", payment);
        verifyPayment(payment);
        
    },

    modal: {
        ondismiss: function () {
            Swal.fire("Payment Cancelled", "Popup closed!", "error");
        }
    }
};


  let rzp = new Razorpay(options);

// ðŸ”¥ FULL DEBUG LOGS FOR SUCCESS / FAILURE / REDIRECT
    rzp.on("payment.success", function (resp) {
        console.log("ðŸ”¥ Payment Success Event:", resp);
        verifyPayment(resp);
    });

    rzp.on("payment.error", function (err) {
        console.log("âŒ Payment Error Event:", err);
        Swal.fire("Payment Failed", err.error.description, "error");
    });

    console.log("ðŸ“Œ Razorpay initialized:", options);
    rzp.open();
    console.log("ðŸ“Œ Popup opened");
    stopLoader(); // Loader stops when popup shows


}

async function verifyPayment(payment) {
  Swal.fire({ title: "Verifying Payment...", didOpen: ()=>Swal.showLoading(), allowOutsideClick:false });

  let formData = new FormData();
  formData.append("razorpay_payment_id", payment.razorpay_payment_id);
  formData.append("razorpay_order_id", payment.razorpay_order_id);
  formData.append("razorpay_signature", payment.razorpay_signature);

  let res = await fetch("{% url 'razorpay_verify' %}", {
      method: "POST",
      body: formData,
      headers: {"X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value}
  });
  let result = await res.json();

  if(result.success){
      Swal.fire({icon:"success",title:"Payment Success!",timer:1500,showConfirmButton:false});
      setTimeout(()=>window.location.href="{% url 'order_success' %}",1300);
  } else {
      Swal.fire("Payment Failed", result.error, "error");
  }
}
</script>

</body>
</html>
