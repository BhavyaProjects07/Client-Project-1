<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Dashboard | Logistics Center</title>

    <!-- Google Fonts: Inter for that premium app feel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- TailwindCSS with Custom Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
        }
        
        /* Smooth Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Custom Select Arrow */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2364748b%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem top 50%;
            background-size: 0.65rem auto;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen text-slate-800 antialiased selection:bg-brand-100 selection:text-brand-900">

    <!-- Navbar Include -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-b border-slate-200">
        {% include 'nav.html' %}
    </div>

    <!-- Main Container -->
    <div id="mainContent" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 animate-fade-in-up">
        
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Delivery Dashboard</h1>
                <p class="text-slate-500 mt-1">Manage assignments, track status, and update deliveries.</p>
            </div>
            
            <!-- History Button (Styled as Secondary Action) -->
            <button onclick="loadHistory()" class="group flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-brand-600 transition-colors bg-white px-4 py-2 rounded-lg border border-slate-200 shadow-sm hover:shadow-md hover:border-brand-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform group-hover:-rotate-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                View Order History
            </button>
        </div>

        <!-- Search & Filter Bar -->
        <div class="bg-white p-1 rounded-2xl shadow-sm border border-slate-200 mb-10">
            <form method="get" class="grid grid-cols-1 md:grid-cols-12 gap-2 p-1">
                
                <!-- Search Input -->
                <div class="md:col-span-5 relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-slate-400 group-focus-within:text-brand-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <input 
                        type="text" 
                        name="name" 
                        value="{{ name_q }}"
                        placeholder="Search customer name..."
                        class="block w-full pl-10 pr-3 py-3 border-transparent bg-slate-50 rounded-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all sm:text-sm font-medium"
                    >
                </div>

                <!-- Date Input -->
                <div class="md:col-span-4 relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-slate-400 group-focus-within:text-brand-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <input 
                        type="date" 
                        name="date"
                        value="{{ date_q }}"
                        class="block w-full pl-10 pr-3 py-3 border-transparent bg-slate-50 rounded-xl text-slate-900 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-brand-500 focus:border-transparent transition-all sm:text-sm font-medium"
                    >
                </div>

                <!-- Submit Button -->
                <div class="md:col-span-3">
                    <button 
                        class="w-full h-full bg-slate-900 hover:bg-slate-800 text-white font-semibold rounded-xl px-6 py-3 transition-all duration-200 transform hover:scale-[1.02] shadow-lg shadow-slate-900/20 flex justify-center items-center gap-2">
                        <span>Search Orders</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Pagination (Top) -->
        <div class="flex justify-between items-center mb-6">
            <span class="text-sm font-medium text-slate-500">
                Page <span class="text-slate-900">{{ page_obj.number }}</span> of {{ page_obj.paginator.num_pages }}
            </span>

            <div class="flex gap-2">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-50 hover:border-slate-300 transition-colors shadow-sm">
                        ← Prev
                    </a>
                {% else %}
                    <span class="px-4 py-2 bg-slate-50 border border-slate-100 text-slate-300 rounded-lg text-sm font-medium cursor-not-allowed">
                        ← Prev
                    </span>
                {% endif %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-50 hover:border-slate-300 transition-colors shadow-sm">
                        Next →
                    </a>
                {% else %}
                    <span class="px-4 py-2 bg-slate-50 border border-slate-100 text-slate-300 rounded-lg text-sm font-medium cursor-not-allowed">
                        Next →
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Orders Grid -->
        <div class="grid grid-cols-1 gap-8">
            {% for order in orders %}
            
            <!-- Order Card -->
            <div class="group bg-white rounded-2xl border border-slate-200 shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07),0_10px_20px_-2px_rgba(0,0,0,0.04)] hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden">
                
                <!-- Card Header -->
                <div class="bg-gradient-to-r from-slate-50 to-white border-b border-slate-100 px-6 py-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <div class="flex items-center gap-3">
                        <div class="bg-brand-50 text-brand-700 p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Order ID</p>
                            <h2 class="text-lg font-bold text-slate-900">#{{ order.id }}</h2>
                        </div>
                    </div>

                    <!-- Status Badges with Modern Look -->
                    {% if order.order_status == 'Pending pickup' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-amber-600 animate-pulse"></span> Pending Pickup
                        </span>
                    {% elif order.order_status == 'Out for delivery' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-sky-50 text-sky-700 ring-1 ring-inset ring-sky-600/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-sky-600 animate-pulse"></span> Out for Delivery
                        </span>
                    {% elif order.order_status == 'Delivered' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700 ring-1 ring-inset ring-emerald-600/20">
                            <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            Delivered
                        </span>
                    {% elif order.order_status == 'Return initiated' %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/20">
                            Return Initiated
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 ring-1 ring-inset ring-slate-500/10">
                            {{ order.order_status }}
                        </span>
                    {% endif %}
                </div>

                <!-- Card Body: Information Grid -->
                <div class="px-6 py-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- Customer Info -->
                        <div class="space-y-3">
                            <h3 class="text-sm font-semibold text-slate-900 border-b border-slate-100 pb-1 mb-2">Customer Details</h3>
                            
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-slate-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <div>
                                    <p class="text-sm font-medium text-slate-900">{{ order.full_name }}</p>
                                    <p class="text-xs text-slate-500">Customer</p>
                                </div>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-slate-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                <p class="text-sm text-slate-600 break-all">{{ order.user.email }}</p>
                            </div>

                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-slate-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                <p class="text-sm text-slate-600 font-mono">{{ order.phone_number }}</p>
                            </div>
                        </div>

                        <!-- Logistics Info -->
                        <div class="space-y-3">
                            <h3 class="text-sm font-semibold text-slate-900 border-b border-slate-100 pb-1 mb-2">Delivery Location</h3>
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <p class="text-sm text-slate-600 leading-relaxed">{{ order.address }}</p>
                            </div>
                        </div>

                        <!-- Payment Info -->
                        <div class="space-y-3">
                            <h3 class="text-sm font-semibold text-slate-900 border-b border-slate-100 pb-1 mb-2">Payment Details</h3>
                            
                            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <span class="text-xs text-slate-500 uppercase font-semibold">Method</span>
                                <span class="text-sm font-medium text-slate-700">{{ order.payment_method }}</span>
                            </div>

                            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <span class="text-xs text-slate-500 uppercase font-semibold">Status</span>
                                {% if order.paid %}
                                    <span class="flex items-center gap-1 text-sm font-bold text-emerald-600">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Paid
                                    </span>
                                {% else %}
                                    <span class="flex items-center gap-1 text-sm font-bold text-red-600">
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        Pending
                                    </span>
                                {% endif %}
                            </div>

                            <div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-100">
                                <svg class="w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                <span class="text-xs text-slate-500">Ordered: {{ order.created_at|date:"M d, Y" }}</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Action Footer (Control Center) -->
                <div class="bg-slate-50 border-t border-slate-200 px-6 py-5">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-end">
                        
                        <!-- Order Status Form -->
                        <div class="lg:col-span-5">
                            <form method="post" action="{% url 'update_order_status' order.id %}" class="relative">
                                {% csrf_token %}
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5 ml-1">Update Status</label>
                                <div class="flex shadow-sm rounded-lg">
                                    <select name="order_status" class="block w-full rounded-l-lg border-0 py-2.5 pl-3 pr-10 text-slate-900 ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-brand-600 sm:text-sm sm:leading-6 bg-white transition-shadow">
                                        <option value="Pending pickup" {% if order.order_status == 'Pending pickup' %}selected{% endif %}>Pending pickup</option>
                                        <option value="Out for delivery" {% if order.order_status == 'Out for delivery' %}selected{% endif %}>Out for delivery</option>
                                        <option value="Delivered" {% if order.order_status == 'Delivered' %}selected{% endif %}>Delivered</option>
                                        <option value="Cancelled" {% if order.order_status == 'Cancelled' %}selected{% endif %} disabled class="text-gray-400 bg-gray-50">Cancelled (Admin Only)</option>
                                    </select>
                                    <button class="relative -ml-px inline-flex items-center gap-x-1.5 rounded-r-lg px-4 py-2 text-sm font-semibold text-white bg-brand-600 hover:bg-brand-700 ring-1 ring-inset ring-brand-700 focus:z-10 transition-colors">
                                        Update
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Payment Status Form -->
                        <div class="lg:col-span-4">
                            <form method="post" action="{% url 'update_payment_status' order.id %}" class="relative">
                                {% csrf_token %}
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1.5 ml-1">Update Payment</label>
                                <div class="flex shadow-sm rounded-lg">
                                    <select name="payment_status" class="block w-full rounded-l-lg border-0 py-2.5 pl-3 pr-10 text-slate-900 ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-emerald-600 sm:text-sm sm:leading-6 bg-white transition-shadow">
                                        <option value="Paid" {% if order.paid %}selected{% endif %}>Paid</option>
                                        <option value="Not Paid" {% if not order.paid %}selected{% endif %}>Not Paid</option>
                                    </select>
                                    <button class="relative -ml-px inline-flex items-center gap-x-1.5 rounded-r-lg px-4 py-2 text-sm font-semibold text-white bg-emerald-600 hover:bg-emerald-700 ring-1 ring-inset ring-emerald-700 focus:z-10 transition-colors">
                                        Save
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Detail Link -->
                        <div class="lg:col-span-3">
                            <a href="{% url 'delivery_order_detail' order.id %}" class="block w-full">
                                <button class="w-full inline-flex justify-center items-center gap-2 rounded-lg bg-white px-4 py-2.5 text-sm font-semibold text-slate-700 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 hover:text-brand-600 transition-all">
                                    Full Details
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                    </svg>
                                </button>
                            </a>
                        </div>
                    </div>
                </div>

            </div>
            {% empty %}
                <!-- Empty State -->
                <div class="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
                        <svg class="w-8 h-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-slate-900">No assigned orders found</h3>
                    <p class="text-slate-500 mt-1">Assignments will appear here once dispatched.</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Script to preserve functionality -->
    <script>
    function loadHistory() {
        // Adding a simple loading state indicator
        const container = document.getElementById("mainContent");
        container.style.opacity = '0.5';
        
        fetch("{% url 'delivery_order_history' %}")
        .then(res => res.text())
        .then(html => {
            container.innerHTML = html;
            container.style.opacity = '1';
            // Re-trigger animation
            container.classList.remove('animate-fade-in-up');
            void container.offsetWidth; // trigger reflow
            container.classList.add('animate-fade-in-up');
        })
        .catch(err => {
            console.error('Error loading history', err);
            container.style.opacity = '1';
        });
    }
    </script>
</body>
</html>
